name: Deploy Game Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install backend dependencies (for validation)
      run: |
        cd backend
        npm ci || npm install
    
    - name: Test backend (if tests exist)
      run: |
        cd backend
        npm test || echo "No tests found, skipping..."
    
    - name: Prepare frontend for GitHub Pages
      run: |
        echo "ðŸ”§ å‡†å¤‡å‰ç«¯æ–‡ä»¶..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ ä»»ä½•å‰ç«¯æž„å»ºæ­¥éª¤
        # ä¾‹å¦‚ï¼šåŽ‹ç¼©æ–‡ä»¶ã€ä¼˜åŒ–èµ„æºç­‰
        
        # åˆ›å»ºä¸€ä¸ª .nojekyll æ–‡ä»¶ï¼Œå‘Šè¯‰ GitHub Pages ä¸è¦ä½¿ç”¨ Jekyll
        touch .nojekyll
        
        echo "âœ… å‰ç«¯å‡†å¤‡å®Œæˆ"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: 'backend/node_modules,backend/data,*.log,.env'
        commit_message: 'Deploy: ${{ github.event.head_commit.message }}'
    
    - name: Create deployment summary
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ åŠŸèƒ½çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å‰ç«¯ç•Œé¢" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… MQTT è¿žæŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ¬åœ°å­˜å‚¨" >> $GITHUB_STEP_SUMMARY
        echo "- âš ï¸ äº‘ç«¯å­˜å‚¨ (éœ€è¦å•ç‹¬éƒ¨ç½²åŽå°æœåŠ¡)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“– åŽç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
        echo "1. ç­‰å¾… 3-5 åˆ†é’Ÿè®©éƒ¨ç½²ç”Ÿæ•ˆ" >> $GITHUB_STEP_SUMMARY
        echo "2. è®¿é—®ä¸Šé¢çš„åœ°å€æµ‹è¯•åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "3. å¦‚éœ€äº‘ç«¯å­˜å‚¨ï¼Œå‚è€ƒ GITHUB_PAGES_DEPLOY.md" >> $GITHUB_STEP_SUMMARY