name: Deploy Game Monitor to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install backend dependencies (for validation)
      run: |
        cd backend
        npm ci || npm install
    
    - name: Test backend (if tests exist)
      run: |
        cd backend
        npm test || echo "No tests found, skipping..."
    
    - name: Prepare frontend for GitHub Pages
      run: |
        echo "🔧 准备前端文件..."
        # 这里可以添加任何前端构建步骤
        # 例如：压缩文件、优化资源等
        
        # 创建一个 .nojekyll 文件，告诉 GitHub Pages 不要使用 Jekyll
        touch .nojekyll
        
        echo "✅ 前端准备完成"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: 'backend/node_modules,backend/data,*.log,.env'
        commit_message: 'Deploy: ${{ github.event.head_commit.message }}'
    
    - name: Create deployment summary
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "## 🚀 部署完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 访问地址" >> $GITHUB_STEP_SUMMARY
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔧 功能状态" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 前端界面" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MQTT 连接" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ 本地存储" >> $GITHUB_STEP_SUMMARY
        echo "- ⚠️ 云端存储 (需要单独部署后台服务)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📖 后续步骤" >> $GITHUB_STEP_SUMMARY
        echo "1. 等待 3-5 分钟让部署生效" >> $GITHUB_STEP_SUMMARY
        echo "2. 访问上面的地址测试功能" >> $GITHUB_STEP_SUMMARY
        echo "3. 如需云端存储，参考 GITHUB_PAGES_DEPLOY.md" >> $GITHUB_STEP_SUMMARY