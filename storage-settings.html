<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜å‚¨è®¾ç½® - æ¸¸æˆæ—¶é•¿ç›‘æ§é¢æ¿</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .storage-option {
            background: #f7fafc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s;
        }

        .storage-option:hover {
            background: #edf2f7;
            transform: translateX(4px);
        }

        .storage-option.selected {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .storage-option.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .storage-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .storage-description {
            color: #718096;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .storage-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .feature-tag {
            background: #e6fffa;
            color: #2d3748;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid rgba(66, 153, 225, 0.2);
        }

        .feature-tag.pro {
            background: #fed7d7;
            border-color: rgba(245, 101, 101, 0.2);
        }

        .feature-tag.free {
            background: #c6f6d5;
            border-color: rgba(72, 187, 120, 0.2);
        }

        .storage-config {
            margin-top: 15px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .config-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-row label {
            min-width: 120px;
            font-weight: 600;
            color: #4a5568;
        }

        .config-row input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .config-row button {
            margin-left: 10px;
            padding: 8px 16px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #48bb78;
        }

        .status-indicator.offline {
            background: #f56565;
        }

        .status-indicator.unknown {
            background: #ed8936;
        }

        .migration-panel {
            background: #fffbf0;
            border: 1px solid #fbd38d;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .migration-panel h3 {
            color: #c05621;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ å­˜å‚¨è®¾ç½®</h1>
            <div class="connection-status">
                <a href="index.html" style="color: #4299e1; text-decoration: none; font-weight: 600;">â† è¿”å›ä¸»é¡µ</a>
            </div>
        </header>

        <div style="margin-bottom: 30px;">
            <h2>é€‰æ‹©æ•°æ®å­˜å‚¨æ–¹æ¡ˆ</h2>
            <p style="color: #718096; margin-bottom: 20px;">
                é€‰æ‹©æœ€é€‚åˆæ‚¨éœ€æ±‚çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚æ¯ç§æ–¹æ¡ˆéƒ½æœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚
            </p>

            <!-- localStorage æ–¹æ¡ˆ -->
            <div class="storage-option" id="localStorageOption">
                <div class="storage-title">
                    <span class="status-indicator online"></span>
                    ğŸ“± æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ (localStorage)
                    <span class="feature-tag free">å…è´¹</span>
                    <span class="feature-tag">é»˜è®¤</span>
                </div>
                <div class="storage-description">
                    æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼Œå®Œå…¨å…è´¹ã€‚é€‚åˆå•è®¾å¤‡ä½¿ç”¨ã€‚
                </div>
                <div class="storage-features">
                    <span class="feature-tag">é›¶é…ç½®</span>
                    <span class="feature-tag">å®Œå…¨ç¦»çº¿</span>
                    <span class="feature-tag">éšç§å®‰å…¨</span>
                    <span class="feature-tag pro">ä»…é™å•è®¾å¤‡</span>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="selectStorage('localStorage')">ä½¿ç”¨æ­¤æ–¹æ¡ˆ</button>
                </div>
            </div>

            <!-- IndexedDB æ–¹æ¡ˆ -->
            <div class="storage-option" id="indexedDBOption">
                <div class="storage-title">
                    <span class="status-indicator unknown" id="indexedDBStatus"></span>
                    ğŸ—„ï¸ é«˜çº§æµè§ˆå™¨å­˜å‚¨ (IndexedDB)
                    <span class="feature-tag free">å…è´¹</span>
                    <span class="feature-tag">æ¨è</span>
                </div>
                <div class="storage-description">
                    æµè§ˆå™¨åŸç”Ÿæ•°æ®åº“ï¼Œæ”¯æŒå¤§å®¹é‡å­˜å‚¨å’Œå¤æ‚æŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½ã€‚
                </div>
                <div class="storage-features">
                    <span class="feature-tag">å¤§å®¹é‡</span>
                    <span class="feature-tag">é«˜æ€§èƒ½</span>
                    <span class="feature-tag">å¤æ‚æŸ¥è¯¢</span>
                    <span class="feature-tag">æ•°æ®å®Œæ•´æ€§</span>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="selectStorage('indexedDB')" id="indexedDBBtn">ä½¿ç”¨æ­¤æ–¹æ¡ˆ</button>
                    <button onclick="testIndexedDB()" style="background: #718096;">æµ‹è¯•å…¼å®¹æ€§</button>
                </div>
            </div>

            <!-- GitHub Gist æ–¹æ¡ˆ -->
            <div class="storage-option" id="githubGistOption">
                <div class="storage-title">
                    <span class="status-indicator offline" id="gistStatus"></span>
                    ğŸŒ GitHub Gist äº‘å­˜å‚¨
                    <span class="feature-tag free">å…è´¹</span>
                    <span class="feature-tag">è·¨è®¾å¤‡</span>
                </div>
                <div class="storage-description">
                    ä½¿ç”¨ GitHub Gist ä½œä¸ºå…è´¹çš„äº‘å­˜å‚¨ï¼Œæ”¯æŒè·¨è®¾å¤‡åŒæ­¥ï¼Œéœ€è¦ GitHub è´¦å·ã€‚
                </div>
                <div class="storage-features">
                    <span class="feature-tag">è·¨è®¾å¤‡åŒæ­¥</span>
                    <span class="feature-tag">ç‰ˆæœ¬æ§åˆ¶</span>
                    <span class="feature-tag">åœ¨çº¿å¤‡ä»½</span>
                    <span class="feature-tag pro">éœ€è¦ GitHub</span>
                </div>
                <div class="storage-config" id="gistConfig" style="display: none;">
                    <div class="config-row">
                        <label>GitHub Token:</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        <button onclick="setGitHubToken()">è®¾ç½®</button>
                    </div>
                    <div class="config-row">
                        <label>Gist ID:</label>
                        <input type="text" id="gistId" placeholder="è‡ªåŠ¨ç”Ÿæˆ" readonly>
                        <button onclick="clearGistConfig()">æ¸…é™¤</button>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 6px; font-size: 0.85rem;">
                        <strong>é…ç½®æ­¥éª¤ï¼š</strong><br>
                        1. è®¿é—® <a href="https://github.com/settings/tokens" target="_blank">GitHub Token é¡µé¢</a><br>
                        2. åˆ›å»ºæ–° Tokenï¼Œé€‰æ‹© "gist" æƒé™<br>
                        3. å¤åˆ¶ Token å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†<br>
                        4. ç‚¹å‡»"è®¾ç½®"æŒ‰é’®å®Œæˆé…ç½®
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="selectStorage('githubGist')">ä½¿ç”¨æ­¤æ–¹æ¡ˆ</button>
                    <button onclick="toggleGistConfig()" style="background: #718096;">é…ç½®</button>
                </div>
            </div>

            <!-- åå°æœåŠ¡æ–¹æ¡ˆ (ä¿æŒå…¼å®¹æ€§) -->
            <div class="storage-option" id="backendOption">
                <div class="storage-title">
                    <span class="status-indicator offline" id="backendStatus"></span>
                    ğŸš€ åå°æ•°æ®åº“æœåŠ¡
                    <span class="feature-tag pro">éœ€è¦éƒ¨ç½²</span>
                    <span class="feature-tag">ä¼ä¸šçº§</span>
                </div>
                <div class="storage-description">
                    å®Œæ•´çš„åå°æ•°æ®åº“æœåŠ¡ï¼Œæ”¯æŒé«˜æ€§èƒ½æŸ¥è¯¢å’Œå¤šç”¨æˆ·è®¿é—®ã€‚éœ€è¦éƒ¨ç½²åˆ° Railway ç­‰äº‘æœåŠ¡ã€‚
                </div>
                <div class="storage-features">
                    <span class="feature-tag">é«˜æ€§èƒ½</span>
                    <span class="feature-tag">å¤šç”¨æˆ·</span>
                    <span class="feature-tag">ä¼ä¸šçº§</span>
                    <span class="feature-tag pro">éœ€è¦äº‘æœåŠ¡</span>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="window.open('DATABASE_USAGE_GUIDE.md', '_blank')" style="background: #718096;">æŸ¥çœ‹éƒ¨ç½²æŒ‡å—</button>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¿ç§» -->
        <div class="migration-panel">
            <h3>ğŸ”„ æ•°æ®è¿ç§»</h3>
            <p style="color: #744210; margin-bottom: 15px;">
                å¦‚æœæ‚¨éœ€è¦åœ¨ä¸åŒå­˜å‚¨æ–¹æ¡ˆä¹‹é—´è¿ç§»æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼š
            </p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="exportCurrentData()" style="background: #ed8936;">å¯¼å‡ºå½“å‰æ•°æ®</button>
                <button onclick="importData()" style="background: #4299e1;">å¯¼å…¥æ•°æ®</button>
                <button onclick="migrateToSelected()" style="background: #48bb78;">è¿ç§»åˆ°æ‰€é€‰æ–¹æ¡ˆ</button>
            </div>
        </div>

        <!-- å­˜å‚¨çŠ¶æ€ -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
            <h3>ğŸ“Š å½“å‰å­˜å‚¨çŠ¶æ€</h3>
            <div id="storageStatus">
                <p>æ­£åœ¨æ£€æŸ¥å­˜å‚¨çŠ¶æ€...</p>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å­˜å‚¨è„šæœ¬ -->
    <script src="indexeddb-storage.js"></script>
    <script src="github-gist-storage.js"></script>
    
    <script>
        let currentStorage = localStorage.getItem('gameMonitor_storageType') || 'localStorage';
        let indexedDBStorage = null;
        let gistStorage = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeStorageOptions();
            updateStorageStatus();
            updateUI();
        });

        // åˆå§‹åŒ–å­˜å‚¨é€‰é¡¹
        async function initializeStorageOptions() {
            // æµ‹è¯• IndexedDB æ”¯æŒ
            if ('indexedDB' in window) {
                try {
                    indexedDBStorage = new IndexedDBStorage();
                    await indexedDBStorage.initialize();
                    document.getElementById('indexedDBStatus').className = 'status-indicator online';
                    document.getElementById('indexedDBBtn').disabled = false;
                } catch (error) {
                    console.warn('IndexedDB åˆå§‹åŒ–å¤±è´¥:', error);
                    document.getElementById('indexedDBStatus').className = 'status-indicator offline';
                    document.getElementById('indexedDBOption').classList.add('disabled');
                }
            } else {
                document.getElementById('indexedDBStatus').className = 'status-indicator offline';
                document.getElementById('indexedDBOption').classList.add('disabled');
            }

            // åˆå§‹åŒ– GitHub Gist
            gistStorage = new GitHubGistStorage();
            const gistStatus = gistStorage.getStatus();
            
            if (gistStatus.configured) {
                document.getElementById('gistStatus').className = 'status-indicator online';
                document.getElementById('githubToken').value = 'å·²é…ç½® âœ“';
                document.getElementById('gistId').value = gistStatus.gistId;
            }
        }

        // é€‰æ‹©å­˜å‚¨æ–¹æ¡ˆ
        function selectStorage(type) {
            currentStorage = type;
            localStorage.setItem('gameMonitor_storageType', type);
            updateUI();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(`å·²åˆ‡æ¢åˆ° ${getStorageName(type)} å­˜å‚¨æ–¹æ¡ˆ`);
        }

        // æ›´æ–° UI
        function updateUI() {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.storage-option').forEach(option => {
                option.classList.remove('selected');
            });

            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            const currentOption = document.getElementById(currentStorage + 'Option');
            if (currentOption) {
                currentOption.classList.add('selected');
            }
        }

        // è·å–å­˜å‚¨æ–¹æ¡ˆåç§°
        function getStorageName(type) {
            const names = {
                'localStorage': 'æµè§ˆå™¨æœ¬åœ°å­˜å‚¨',
                'indexedDB': 'é«˜çº§æµè§ˆå™¨å­˜å‚¨',
                'githubGist': 'GitHub Gist äº‘å­˜å‚¨',
                'backend': 'åå°æ•°æ®åº“æœåŠ¡'
            };
            return names[type] || type;
        }

        // æµ‹è¯• IndexedDB
        async function testIndexedDB() {
            try {
                const testDB = new IndexedDBStorage();
                await testDB.initialize();
                const stats = await testDB.getStorageStats();
                alert(`IndexedDB æµ‹è¯•æˆåŠŸï¼\nç”¨æˆ·æ•°: ${stats.userCount}\næ•°æ®åº“ç‰ˆæœ¬: ${stats.dbVersion}`);
            } catch (error) {
                alert(`IndexedDB æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ‡æ¢ Gist é…ç½®æ˜¾ç¤º
        function toggleGistConfig() {
            const config = document.getElementById('gistConfig');
            config.style.display = config.style.display === 'none' ? 'block' : 'none';
        }

        // è®¾ç½® GitHub Token
        function setGitHubToken() {
            const token = document.getElementById('githubToken').value;
            if (token && token !== 'å·²é…ç½® âœ“') {
                gistStorage.setAccessToken(token);
                document.getElementById('gistStatus').className = 'status-indicator online';
                document.getElementById('githubToken').value = 'å·²é…ç½® âœ“';
                alert('GitHub Token é…ç½®æˆåŠŸï¼');
            }
        }

        // æ¸…é™¤ Gist é…ç½®
        function clearGistConfig() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ GitHub Gist é…ç½®å—ï¼Ÿ')) {
                gistStorage.clearConfig();
                document.getElementById('gistStatus').className = 'status-indicator offline';
                document.getElementById('githubToken').value = '';
                document.getElementById('gistId').value = '';
                alert('é…ç½®å·²æ¸…é™¤');
            }
        }

        // å¯¼å‡ºå½“å‰æ•°æ®
        function exportCurrentData() {
            try {
                const gameData = localStorage.getItem('gameMonitorData');
                const settings = localStorage.getItem('mqttConnectionSettings');
                
                const exportData = {
                    gameData: gameData ? JSON.parse(gameData) : null,
                    settings: settings ? JSON.parse(settings) : null,
                    storageType: currentStorage,
                    exportTime: new Date().toISOString(),
                    version: '2.0'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `game-monitor-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                console.log('æ•°æ®å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                alert('æ•°æ®å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);

                        if (importData.gameData) {
                            localStorage.setItem('gameMonitorData', JSON.stringify(importData.gameData));
                        }

                        if (importData.settings) {
                            localStorage.setItem('mqttConnectionSettings', JSON.stringify(importData.settings));
                        }

                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼è¯·è¿”å›ä¸»é¡µé¢æŸ¥çœ‹ã€‚');
                    } catch (error) {
                        alert('æ•°æ®å¯¼å…¥å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // è¿ç§»åˆ°æ‰€é€‰æ–¹æ¡ˆ
        async function migrateToSelected() {
            if (currentStorage === 'localStorage') {
                alert('å½“å‰å·²ä½¿ç”¨ localStorageï¼Œæ— éœ€è¿ç§»');
                return;
            }

            try {
                const gameData = localStorage.getItem('gameMonitorData');
                if (!gameData) {
                    alert('æ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿ç§»çš„æ•°æ®');
                    return;
                }

                const data = JSON.parse(gameData);

                if (currentStorage === 'indexedDB' && indexedDBStorage) {
                    await indexedDBStorage.saveUserData('migrated_user', data);
                    alert('æ•°æ®å·²æˆåŠŸè¿ç§»åˆ° IndexedDB');
                } else if (currentStorage === 'githubGist' && gistStorage) {
                    await gistStorage.saveToGist(data);
                    alert('æ•°æ®å·²æˆåŠŸè¿ç§»åˆ° GitHub Gist');
                } else {
                    alert('ç›®æ ‡å­˜å‚¨æ–¹æ¡ˆä¸å¯ç”¨æˆ–æœªé…ç½®');
                }

            } catch (error) {
                alert('æ•°æ®è¿ç§»å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°å­˜å‚¨çŠ¶æ€
        function updateStorageStatus() {
            const statusDiv = document.getElementById('storageStatus');
            
            try {
                const gameData = localStorage.getItem('gameMonitorData');
                const data = gameData ? JSON.parse(gameData) : null;
                
                const status = `
                    <p><strong>å½“å‰å­˜å‚¨æ–¹æ¡ˆ:</strong> ${getStorageName(currentStorage)}</p>
                    <p><strong>æ•°æ®å¤§å°:</strong> ${gameData ? (gameData.length / 1024).toFixed(2) + ' KB' : '0 KB'}</p>
                    <p><strong>ç©å®¶æ•°é‡:</strong> ${data?.players?.length || 0}</p>
                    <p><strong>äº‹ä»¶æ•°é‡:</strong> ${data?.events?.length || 0}</p>
                    <p><strong>æœ€åæ›´æ–°:</strong> ${data?.timestamp || 'æ— æ•°æ®'}</p>
                `;
                
                statusDiv.innerHTML = status;
            } catch (error) {
                statusDiv.innerHTML = '<p style="color: #f56565;">çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>